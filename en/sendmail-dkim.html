<!doctype html><html lang="en"><head>
<meta charset="utf-8">
<link rel="stylesheet" href="../style2.css">
<title>Sendmail DKIM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Signing sendmail messages with DKIM using OpenDKIM is easier then you think!">
<link rel="canonical" href="http://alexey.shpakovsky.ru/en/sendmail-dkim.html">
</head><body>
<div id="menu">
	<ul>
		<li><a href="../ru/">Русский</a></li>
		<li><a href="../en/">English</a></li>
		<li><a href="../photos/en.html">Photos</a></li>
		<li><a href="../private/">Private</a></li>
	</ul>
</div>
<div id="wrap">
	<div id="header">
		<h1><a href="http://alexey.shpakovsky.ru/en/">Notes</a></h1>
		<p>Notes about different stuff</p>
	</div>
	<div id="content">
		<!-- put contents below -->
		<!-- begin sendmail-dkim -->
		<div class="post">
			<h2><a href="sendmail-dkim.html">Sendmail DKIM</a></h2>
			<p class="trivia">
				Created: 2014-07-06 &mdash; modified: 2014-10-23 &mdash; tags: e-mail
			</p>
			<p class="intro">Signing sendmail messages with DKIM using OpenDKIM is easier then you think!</p>
			<h1>Installation</h1>

<p>Following <a href="https://help.ubuntu.com/community/Postfix/DKIM">Ubuntu's guide</a>, execute this command:</p>

<pre><code>sudo apt-get install opendkim opendkim-tools
</code></pre>

<h1>Configuration</h1>

<p>First, think up a <em>selector</em> used for differentiating this key from others.
If you have different means of sending an email from one @server.com, they might
have different keys. For example I use <a href="http://pdd.yandex.com/">Yandex mail for domain</a>, which
have their own set of private and public keys and use <code>mail</code> selector.
So I decided to use <code>sendmail</code> as a selector for this one.</p>

<h2>Key generation</h2>

<p>Execute this command:</p>

<pre><code>opendkim-genkey -t -s [selector]
</code></pre>

<p>This will generate two files: <code>[selector].priv</code> storing your private key
and <code>[selector].txt</code> storing DNS record.</p>

<p>Move the <code>*.priv</code> file to an appropriate location on the server
(for example, <code>/etc/mail/dkim.key</code>),
and add contents of <code>*.txt</code> file to your DNS.</p>

<h2>DNS</h2>

<p>It depends on your provider and details of your setup, but generally it's about
adding a TXT record for a <code>[selector]._domainkey</code> subdomain.
Contents of this record is in the <code>*.txt</code> file generated by <code>opendkim-genkey</code> command.</p>

<h2>OpenDKIM</h2>

<p>Edit <code>/etc/opendkim.conf</code> file. You need to uncomment and change only these three lines:</p>

<pre><code>Domain  [your domain]
KeyFile [keyfile]
Selector    [selector]
</code></pre>

<p>Where <code>[keyfile]</code> is a path to your private key.</p>

<p>Restart opendkim service:</p>

<pre><code>sudo service opendkim restart
</code></pre>

<h2>Sendmail</h2>

<p>Find out the socket used by opendkim:</p>

<pre><code>ps aux | grep opendkim
</code></pre>

<p>it's after <code>-p</code> parameter and usually is <code>local:/var/run/opendkim/opendkim.sock</code></p>

<p>Edit <code>/etc/mail/sendmail.mc</code> file and add this line anywhere (f.ex, at the bottom):</p>

<pre><code>INPUT_MAIL_FILTER(`opendkim', `S=local:/var/run/opendkim/opendkim.sock')
</code></pre>

<p>(change socket location if it's different in your case)</p>

<p>Finally, rebuild the sendmail config, as it's said on the top of <code>sendmail.mc</code> file:</p>

<pre><code>sendmailconfig
</code></pre>

<h1>Usage</h1>

<p>I believe you know how to send mail, but just in case:</p>

<blockquote>
  <p>To send a message to <code>test@example.com</code>, use this command:</p>

<pre><code>mail -s "Message subject" test@example.com &lt;&lt;&lt;"Message body"
</code></pre>
</blockquote>

<h1>Testing</h1>

<p>To test how this stuff works, you can use one or more of autorespond email addresses
listed at <a href="http://www.dmarc.org/resources.html#Tools">dmarc.org</a>, like this:</p>

<pre><code>echo "test message" | mail -s "DKIM test" checkmyauth@''auth.returnpath.net
</code></pre>
		</div>
		<!-- end sendmail-dkim -->
	</div>
	<div id="footer">
		<a href="http://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution">CC BY</a>
		<a href="/">Alexey Shpakovsky</a> &mdash; <a id="email"
			href="javascript:(l=document.getElementById('email')).href='mailto:'+(l.innerHTML=location.hostname.replace('.','@'));void 0">
			(click to see e-mail)</a>
	</div>
</div>
</body></html>
