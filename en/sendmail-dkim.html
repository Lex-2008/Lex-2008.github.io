<!doctype html><html lang="en"><head>
<meta charset="utf-8">
<title>Sendmail DKIM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Signing sendmail messages with DKIM using OpenDKIM is easier then you think!">
<link rel="canonical" href="http://alexey.shpakovsky.ru/en/sendmail-dkim.html">
<style>
body {
	margin: auto;
	max-width: 80ex;
	text-align: justify;
	hyphens: auto;
	padding: 1ex; /* for ðŸ“± users*/
}
header a, footer a, small a {color: inherit !important} /* linktext */
 
</style>
</head><body>
<header>
	<h1 style="border-bottom: 1px solid lightgray">Sendmail DKIM</h1>
	<small>
		Created: <time>2014-07-06</time> &mdash; modified: <time>2022-01-22</time> &mdash;
		tags: <a href="./#tag:e-mail">e-mail</a>
	</small>
	<hr>
</header>
<main>
	<p class="intro">Signing sendmail messages with DKIM using OpenDKIM is easier then you think!</p>
<blockquote>
  <p><strong>Update:</strong> Note that long after writing this guide, I've switched to Postfix as my mail server, so this guide was correct at the time of writing, it might be obsolete and/or incorrect at the time of reading.</p>
</blockquote>

<h2>Installation</h2>

<p>Following <a href="https://help.ubuntu.com/community/Postfix/DKIM">Ubuntu's guide</a>, execute this command:</p>

<pre><code>sudo apt-get install opendkim opendkim-tools
</code></pre>

<h2>Configuration</h2>

<p>First, think up a <em>selector</em> used for differentiating this key from others.
If you have different means of sending an email from one @server.com, they might
have different keys. For example I use <a href="http://pdd.yandex.com/">Yandex mail for domain</a>, which
have their own set of private and public keys and use <code>mail</code> selector.
So I decided to use <code>sendmail</code> as a selector for this one.</p>

<h3>Key generation</h3>

<p>Execute this command:</p>

<pre><code>opendkim-genkey -t -s [selector]
</code></pre>

<p>This will generate two files: <code>[selector].priv</code> storing your private key
and <code>[selector].txt</code> storing DNS record.</p>

<p>Move the <code>*.priv</code> file to an appropriate location on the server
(for example, <code>/etc/mail/dkim.key</code>),
and add contents of <code>*.txt</code> file to your DNS.</p>

<h3>DNS</h3>

<p>It depends on your provider and details of your setup, but generally it's about
adding a TXT record for a <code>[selector]._domainkey</code> subdomain.
Contents of this record is in the <code>*.txt</code> file generated by <code>opendkim-genkey</code> command.</p>

<h3>OpenDKIM</h3>

<p>Edit <code>/etc/opendkim.conf</code> file. You need to uncomment and change only these three lines:</p>

<pre><code>Domain  [your domain]
KeyFile [keyfile]
Selector    [selector]
</code></pre>

<p>Where <code>[keyfile]</code> is a path to your private key.</p>

<p>Restart opendkim service:</p>

<pre><code>sudo service opendkim restart
</code></pre>

<h3>Sendmail</h3>

<p>Find out the socket used by opendkim:</p>

<pre><code>ps aux | grep opendkim
</code></pre>

<p>it's after <code>-p</code> parameter and usually is <code>local:/var/run/opendkim/opendkim.sock</code></p>

<p>Edit <code>/etc/mail/sendmail.mc</code> file and add this line anywhere (f.ex, at the bottom):</p>

<pre><code>INPUT_MAIL_FILTER(`opendkim', `S=local:/var/run/opendkim/opendkim.sock')
</code></pre>

<p>(change socket location if it's different in your case)</p>

<p>Finally, rebuild the sendmail config, as it's said on the top of <code>sendmail.mc</code> file:</p>

<pre><code>sendmailconfig
</code></pre>

<h2>Usage</h2>

<p>I believe you know how to send mail, but just in case:</p>

<blockquote>
  <p>To send a message to <code>test@example.com</code>, use this command:</p>

<pre><code>mail -s "Message subject" test@example.com &lt;&lt;&lt;"Message body"
</code></pre>
</blockquote>

<h2>Testing</h2>

<p>To test how this stuff works, you can use one or more of autorespond email addresses
listed at <a href="http://www.dmarc.org/resources.html#Tools">dmarc.org</a>, like this:</p>

<pre><code>echo "test message" | mail -s "DKIM test" checkmyauth@''auth.returnpath.net
</code></pre>
</main>
<footer style="text-align: center">
	<hr>
	<p>
		<a href="http://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution">CC BY</a>
		<a href="http://alexey.shpakovsky.ru/">Alexey Shpakovsky</a> &mdash;
		<a href="./">show all posts</a> &mdash;
		<a id="email" href="javascript:(l=document.getElementById('email')).href='mailto:'+(l.innerHTML=location.hostname.replace('.','@'));void 0">show e-mail</a>
	</p>
</footer>
</body></html>
