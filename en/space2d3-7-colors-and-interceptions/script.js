(()=>{function Me(o){let e=parseInt(o,16),t=e>>16&255,i=e>>8&255,r=e&255,n=t/255,a=i/255,p=r/255;n>.04045?n=Math.pow((n+.055)/1.055,2.4):n=n/12.92,a>.04045?a=Math.pow((a+.055)/1.055,2.4):a=a/12.92,p>.04045?p=Math.pow((p+.055)/1.055,2.4):p=p/12.92,n=n*100,a=a*100,p=p*100;let f=(n*.2126+a*.7152+p*.0722)/100;return f>.008856?f=Math.pow(f,1/3):f=7.787*f+16/116,116*f-16}function xe(o){let e=(o+16)/116,t=e,i=e,r=95.047,n=100,a=108.883,[p,c,k]=[t,e,i].map(H=>Math.pow(H,3)>.008856?Math.pow(H,3):(H-16/116)/7.787);p*=r,c*=n,k*=a,t=p/100,e=c/100,i=k/100;let f=t*3.2406+e*-1.5372+i*-.4986,D=f>.0031308?1.055*Math.pow(f,1/2.4)-.055:12.92*f;return D=Math.round(D*255),(1<<24|D<<16|D<<8|D).toString(16).slice(1)}function b(o,e){return o>e&&([o,e]=[e,o]),Math.floor(Math.random()*(e-o+1))+o}function x(o){return o[Math.floor(Math.random()*o.length)]}function _(o){return o.map(e=>({sort:Math.random(),value:e})).sort((e,t)=>e.sort-t.sort).map(e=>e.value)}function O(o){return[...Array(o).keys()]}function l(o){let e=document.getElementById(o);if(!e)throw ReferenceError(`element ${o} not found`);return e}function v(o,e,t,i){l(`status_${o}`).innerHTML=`#status_${o}_${e}{display:block !important}`,t&&(l(`status_${o}_${e}_name`).innerHTML=t.toHTML(!0)),i&&(l(`status_${o}_${e}_days`).innerText=i.toString())}function re(o){l("now-day").innerText=(o+1).toString();let e=Math.floor(o/300)+3e3,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"][Math.floor(o%300/30)],i=Math.floor(o%30)+1;l("now-date").innerText=`${i} ${t} ${e}`}function ne(o){let e=Me(o);return e<50?xe(Math.min(e+50,100)):xe(Math.max(e-50,0))}function S(o,e,...t){if(!o)throw t.length&&console.error(e,...t),new Error(e)}function se(o){return{x:o.x,y:o.y}}var F=class{static id;get mytype(){return this.constructor}get typename(){return this.mytype.id}toJSON(){return{t:this.typename}}static fromJSON(e,t){return new e}};function ae(o){let e=y[o.t];return e.fromJSON(e,o)}var y={};function u(o,e){y[e]=o,o.id=e}var Y=class extends F{static symbol;toText(){return`${this.mytype.symbol||""} ${this.typename}`}};function Z(o){return o.prototype instanceof Y}var le=class extends Y{},L=class extends le{static symbol="\u{1F680}"};u(L,"Rocket");var G=class extends le{static symbol="\u{1F6E2}\uFE0F"};u(G,"Fuel");var J=class extends Y{};var E=class extends J{static color="blue";static symbol="\u{1F4A7}\uFE0F"};u(E,"Water");var X=class extends J{static color="yellow";static symbol="\uFE0F\u26CF\uFE0F"};u(X,"Iron");var z=class extends J{static color="green";static symbol="\uFE0F\u{1F96B}"};u(z,"Food");var U=class extends J{static color="red";static symbol="\uFE0F\u2622\uFE0F"};u(U,"Radioactives");var M=class extends Y{static symbol="\uFE0F\u{1F4E6}\uFE0F";from;to;total;toText(){return`${this.mytype.symbol||""} ${this.typename} to <b>${this.to}</b> planet`}toJSON(){return{t:this.typename,f:this.from,to:this.to,tot:this.total}}static fromJSON(e,t){let i=new e;return i.from=t.f,i.to=t.to,i.total=t.tot,i}};u(M,"MissionBox");function pe(o){return o instanceof M}var _e=["Beast of Burden","Blade of Occam","Lance of Centri","Wasp","Stophy's Venture","Enterprise","Sally Ride","Stellar Explorer","First Light","Lance of Zhargi","Adventurer of Bacia","Astral Enterprise","Star of Kali","Isaur Gypsy","Astral Pioneer","Celestial Maiden","Luna Moth","Harrier","Fralphua's Opportunity","Tory's Venture","Star of Kini","Flame of Rasi","Bolo","Edwin Hubble","Ycon Express","Wren","Spirit of Taly","Illustrious","Yukon","Bara Traveler","Horizon","Star of Icon","Lady of Ghera","Celestial Jewel","Youthful Indiscretion","Gauntlet of Anic","Shoole Trader","Bake Clipper","Jewel of Jocia","Solar Constellation","Uctim Clipper","Castle of Syko","Stellar Jewel","Profit Margin","Irregular of Taly","Swallow","Pathfinder","Celestial Destiny","Spirit of Inquiry"],he=["000000","2f4f4f","556b2f","8b4513","8b0000","808000","483d8b","5f9ea0","008000","3cb371","4682b4","d2691e","9acd32","cd5c5c","00008b","32cd32","daa520","8fbc8f","800080","b03060","ff0000","00ced1","ff8c00","ffd700","ffff00","0000cd","deb887","00ff00","00fa9a","8a2be2","dc143c","00bfff","adff2f","ff6347","da70d6","b0c4de","ff00ff","f0e68c","6495ed","dda0dd","ff1493","7b68ee","ffa07a","afeeee","98fb98","7fffd4","fafad2","ff69b4","ffb6c1","fff0f5"];function je(o,e){let t=Math.hypot(o,e);return[o/t,e/t]}function qe(o,e){return o[0]*e[0]+o[1]*e[1]}function We(o,e,t){let i=je(o.x-e.x,o.y-e.y),r=qe(i,[t.x-e.x,t.y-e.y]);return[e.x+i[0]*r,e.y+i[1]*r]}function be(o,e,t,i){let[r,n]=We(o,e,t);return r>=Math.min(o.x,e.x)&&r<=Math.max(o.x,e.x)&&n>=Math.min(o.y,e.y)&&n<=Math.max(o.y,e.y)&&Math.hypot(r-t.x,n-t.y)<i}var h=50,g=5;function ze(o,e,t,i,r,n){o.beginPath(),i.isAlien?o.rect(e*h,t*h+g,h,h-2*g):o.rect(e*h+g,t*h,h-2*g,h),o.lineWidth=5,o.strokeStyle=i.color,o.fillStyle=i.color2,o.fill(),o.stroke(),o.textBaseline="top",o.fillStyle=i.color,o.fillText(r.cellName||"",e*h+g+5,t*h+5);let p=r.typename[0];r instanceof P&&(p+="C"),r instanceof Q&&(p+="l"),o.fillText(p,e*h+g+5,t*h+5+16),n[e][t]={canBeHere:!0,canGoX:i.isAlien,canGoY:!i.isAlien,ship:i,component:r}}function Ue(o,e,t,i,r){let n=i.passage;o.beginPath(),o.rect((e+n.x)*h,(t+n.y)*h,n.w*h,n.h*h),o.strokeStyle=i.color,o.fillStyle=i.color2,o.fill(),o.stroke();let a=new K;for(let p=0;p<n.w;p++)for(let c=0;c<n.h;c++)r[p+e][c+t]={canBeHere:!0,canGoX:!0,canGoY:!0,ship:i,component:a}}function Pe(o,e,t,i,r,n){let a=o.createLinearGradient(e*h+g,t*h,e*h+g,(t+1)*h),p=o.createLinearGradient(e*h+g,t*h,e*h+g,(t+1)*h);a.addColorStop(0,i.color),a.addColorStop(1,r.color),p.addColorStop(0,i.color2),p.addColorStop(1,r.color2),o.strokeStyle=a,o.fillStyle=p,o.beginPath(),o.moveTo(e*h+g,t*h),o.lineTo(e*h+g*2,(t+.5)*h),o.lineTo(e*h+g,(t+1)*h),o.lineTo((e+1)*h-g,(t+1)*h),o.lineTo((e+1)*h-g*2,(t+.5)*h),o.lineTo((e+1)*h-g,t*h),o.closePath(),o.fill(),o.stroke(),n[e][t]={canBeHere:!0,canGoY:!0,component:new V}}function me(o,e,t,i,r){for(let n=0;n<i.rows.length;n++)for(let a=0;a<i.rows[n].length;a++){let p=i.rows[n][a],c=i.rowToXY(n,a);p.cellName=String.fromCharCode(65+n)+c.y,ze(o,e+c.x,t-c.y,i,p,r)}Ue(o,e,t,i,r)}function Ze(o,e,t,i){let r=e.x*t,n=e.y*t;if(o.fillStyle=e.color,o.fillRect(r-1,n-1,3,3),i!==void 0&&e instanceof m)for(let a=1;a<=i;a++)o.beginPath(),o.arc(r,n,t*a,0,7),o.strokeStyle="red",o.stroke()}function Ve(o,e,t,i,r){i===void 0&&(i=e.x*t),r===void 0&&(r=e.y*t);var n=o.createRadialGradient(i-1,r-1,2,i,r,.2*t);n.addColorStop(0,e.color_in),n.addColorStop(1,e.color_out),o.fillStyle=n,o.beginPath(),o.arc(i,r,.2*t,0,7),o.fill()}function Be(o,e){let t=o.canvas.width,i=t/e.size,r=t/2;if(o.clearRect(0,0,t,t),e.bright){let n=o.createRadialGradient(r,r,0,r,r,i/2);n.addColorStop(0,"white"),n.addColorStop(.5,e.color),n.addColorStop(1,"transparent"),o.fillStyle=n,o.fillRect(0,0,t,t)}else{let n=o.createRadialGradient(r,r,10,r,r,i/2);n.addColorStop(0,e.color),n.addColorStop(1,"transparent"),o.fillStyle=n,o.fillRect(0,0,t,t)}for(let n of e.planets)Ve(o,n,i)}function ke(o,e,t){let i=o.canvas.width,r=i/s.star.size;o.clearRect(0,0,i,i);for(let n of e)(n instanceof m||n.seenBy(s.playerShip,t))&&Ze(o,n,r,t)}function Ke(o,e,t,i,r){let n=r**2*o**2+r**2*e**2-(t*e-i*o)**2,a=(-o*t-e*i+Math.sqrt(n))/(t**2+i**2-r**2),p=(-o*t-e*i-Math.sqrt(n))/(t**2+i**2-r**2);return Math.min(a,p)>0?Math.min(a,p):Math.max(a,p)}function fe(o,e,t,i,r){return r+Ke(e.x-o.x,e.y-o.y,t.x,t.y,i)}var ee=class extends F{cellName="";ship;onEnter(e){}};function De(o){return o.prototype instanceof ee}var j=class extends ee{},V=class extends j{onEnter(e){l("Airlock_Locked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"":"none",l("Airlock_UnLocked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"none":"",l("Airlock_Detach").onclick=()=>{e.depart()}}};u(V,"Airlock");var K=class extends j{};u(K,"Passage");var w=class extends j{opposite="";onEnter(e){document.querySelector("#Ballast b").innerText=this.opposite||""}};u(w,"Ballast");var Ce=class o extends j{original="";toJSON(){return{t:this.typename,o:this.original}}static fromJSON(e,t){let i=new o;return i.original=t.o,i}};u(Ce,"Debris");var $=class extends ee{};function q(o){return o.prototype instanceof $&&!(o.prototype instanceof P)}var R=class o extends ${cargo=[];toJSON(){return{t:this.typename,c:this.cargo.map(e=>e.toJSON())}}static fromJSON(e,t){let i=new o;return i.cargo=t.c.map(r=>ae(r)),i}onEnter(e){document.querySelector("#CargoBay ul").innerHTML=this.cargo.map(t=>`<li>${t.toText()}</li>`).join(""),document.getElementById("CargoBay_Empty").style.display=this.cargo.length==0?"":"none",document.getElementById("CargoBay_NonEmpty").style.display=this.cargo.length==0?"none":""}};u(R,"CargoBay");function B(o){return o instanceof R}var A=class o extends ${lastHTMLUpdate=0;oldHTML="";onEnter(e){let i=document.querySelector("#Radar canvas").getContext("2d");this.drawRadar(),l("Radar_target").onclick=r=>{r.target?.value&&(e.playerShip.targetShip=e.star.ships[r.target.value])}}shipDiv(e){let t=e.ship,i=e.dist,r=Math.ceil(i/.1),n=t===s.playerShip.targetShip?"checked":"",a=t===s.playerShip?"disabled":"";return`
            <label><input type="radio" name="Radar_target" value="${t.i}" id="Radar_target_${t.i}" ${a} ${n}>
            ${t.toHTML(!1,s.playerShip)}<br>
        </label>`}drawRadar(e){let t=l("shipsCanvas");if(t.offsetParent===null)return;let i=t.getContext("2d");s.tick(e)&&window.requestAnimationFrame(p=>{this.drawRadar(p)});let r=this.ship;if(r===void 0)return;let n=r.componentTypes[o.id];ke(i,s.star.ships,n);let a=s.star.ships.filter(p=>p.seenBy(s.playerShip,n)).map(p=>({ship:p,dist:s.playerShip.distanceTo(p)})).sort((p,c)=>p.dist-c.dist).map(this.shipDiv).join("");a!=this.oldHTML&&(!e||this.lastHTMLUpdate+500<=e)&&(l("Radar_target").innerHTML=a,this.oldHTML=a,e&&(this.lastHTMLUpdate=e))}};u(A,"Radar");var Q=class extends ${};u(Q,"Cloak");var P=class extends ${};function Oe(o){return o.prototype instanceof P&&!(o.prototype instanceof ye)}var te=class extends P{lastHTMLUpdate=0;oldHTML="";target;planetTr(e){let t=e.planet,i=e.i,r=Math.ceil(s.playerShip.distanceTo(t)/.1),n=t==this.target?"checked":"",a=t==s.playerShip.onPlanet?"disabled":"";return`<tr><td>
            <input type="radio" name="NavigationComputer_to" value="${i}" id="NavigationComputer_to_${i}" ${a} ${n}>
        </td><td>
            <label for="NavigationComputer_to_${i}">
            ${t.toHTML(!1,s.playerShip,!0)}
        </label></td></tr>`}showDiv(e,t){l("currentComponentPage").innerHTML=`#NavigationComputer_${e}{display:block !important}`,t&&(l("currentComponentPage").innerHTML+=`#NavigationComputer_Intercept_${t}{display:block !important}`)}onEnter(e){this.target=e.playerShip.toPlanet,this.showDiv("Select"),this.drawNC(),document.querySelector("#NavigationComputer table").onclick=t=>{t.target?.value&&(this.target=e.star.planets[t.target.value])},l("NavigationComputer_Plot").style.display=this.ship instanceof m?"none":"",l("NavigationComputer_Fly").style.display=this.ship instanceof m?"":"none",l("NavigationComputer_Plot").onclick=()=>(e.playerShip.planTrip(this.target,e.now),this.showDiv("Detach"),!0),l("NavigationComputer_Fly").onclick=()=>{if(!l("NavigationComputer_Plot")?.onclick?.())return!1;this.showDiv("Departed"),e.state==1&&e.depart(),e.state==2&&e.leaveShip()}}drawNC(e){if(l("NavigationComputer").offsetParent===null)return;s.tick(e)&&window.requestAnimationFrame(r=>{this.drawNC(r)});let t=s.star.planets.map((r,n)=>({planet:r,i:n,dist:s.playerShip.distanceTo(r)})).sort((r,n)=>r.dist-n.dist).map(r=>this.planetTr(r)).join("");t!=this.oldHTML&&(!e||this.lastHTMLUpdate+500<=e)&&(document.querySelector("#NavigationComputer table").innerHTML=t,this.oldHTML=t,e&&(this.lastHTMLUpdate=e));let i=s.playerShip.targetShip;if(!i)this.showDiv("Select","notarget");else if(!i.seenBy(this.ship,this.ship.componentTypes[A.id]))this.showDiv("Select","nosee");else if(i.isIntercepting)this.showDiv("Select","interceptor");else{let r=(i.toPlanet.x-i.fromPoint.x)/(i.toTime-i.fromTime),n=(i.toPlanet.y-i.fromPoint.y)/(i.toTime-i.fromTime),a=fe(this.ship,i,{x:r,y:n},2*.1,s.now);a>i.toTime-2?this.showDiv("Select","notime"):(this.showDiv("Select","div"),l("NavigationComputer_Intercept_ship").innerHTML=i.toHTML(!1,s.playerShip),l("NavigationComputer_Intercept_Plot").style.display=this.ship instanceof m?"none":"",l("NavigationComputer_Intercept_Fly").style.display=this.ship instanceof m?"":"none",l("NavigationComputer_Intercept_Plot").onclick=()=>(this.ship.performIntercept(i,r,n,a,s.now),this.showDiv("Detach"),!0),l("NavigationComputer_Intercept_Fly").onclick=()=>{if(!l("NavigationComputer_Intercept_Plot")?.onclick?.())return!1;this.showDiv("Departed"),s.state==1&&s.depart(),s.state==2&&s.leaveShip()})}}};u(te,"NavigationComputer");var ie=class extends P{showDiv(e){l("currentComponentPage").innerHTML=`#TradingComputer_${e}{display:block !important}`}onEnter(e){let t=e.playerShip.onPlanet;if(t===null){this.showDiv("None");return}if(e.playerShip.countCargo(),t.buys===null){let r=Math.min(e.playerShip.freeCargo,t.ratio);if(r==0){this.showDiv("NoGift");return}this.showDiv("Gift"),l("TradingComputer_gift_number").innerText=r.toString(),l("TradingComputer_gift_type").innerText=t.sells.id,l("TradingComputer_gift_take").onclick=()=>{e.playerShip.putCargo(t.sells,r),this.showDiv("Done")};return}if(e.playerShip.cargoTypes[t.buys.id]<1){this.showDiv("NothingToTradde");return}this.showDiv("Trade");let i=l("TradingComputer_give_slider");l("TradingComputer_give_type").innerText=t.buys.id,l("TradingComputer_get_type").innerText=t.sells.id,i.value=i.max=e.playerShip.cargoTypes[t.buys.id].toString(),i.style.display=e.playerShip.cargoTypes[t.buys.id]==1?"none":"",i.onchange=()=>{let r=parseInt(i.value),n=Math.round(r*t.ratio);l("TradingComputer_max_cargo_warning").style.display=n-r>e.playerShip.freeCargo?"":"none",n=Math.min(n,e.playerShip.freeCargo+r),l("TradingComputer_give_number").innerText=r.toString(),l("TradingComputer_get_number").innerText=n.toString()},i.onchange(),l("TradingComputer_deal").onclick=()=>{let r=parseInt(i.value),n=Math.round(r*t.ratio);n=Math.min(n,e.playerShip.freeCargo+r),e.playerShip.getCargo(t.buys,r),e.playerShip.putCargo(t.sells,n),this.showDiv("Done")}}};u(ie,"TradingComputer");var ye=class extends P{},oe=class extends ye{missionBoxesToHere;deliveryMissionGivesBoxes;deliveryMissionGivesFreeCargoBay;divsShown=["",""];showDiv(e,t){this.divsShown[e]=t,l("currentComponentPage").innerHTML=this.divsShown.map((i,r)=>`#MissionComputer_${r}_${i}{display:block !important}`).join("")}fillRowSelectButtons(e,t){let i=O(s.playerShip.rows.length+1);i.unshift(-1),l(e).innerHTML=i.map(r=>`<button id="${e}_${r+1}">row ${String.fromCharCode(65+r)}</button>`).join(" "),i.forEach(r=>l(`${e}_${r+1}`).onclick=()=>{t(r,this)})}onEnter(e){let t=e.playerShip.onPlanet;if(!t)return;e.playerShip.countCargo();let i=e.playerShip.rows.flat().filter(B),r=[];for(let a of i)r=r.concat(a.cargo.filter(pe));let n=r.filter(a=>a.from===t.name);if(this.missionBoxesToHere=r.filter(a=>a.to===t.name),this.missionBoxesToHere.length){this.showDiv(0,"Complete");let a=Math.max(1,Math.floor(this.missionBoxesToHere.length/2));l("MissionComputer_Complete_resource").innerText=`${a} ${t.sells.id}`,l("MissionComputer_Complete_cargo").innerText=[t.deliveryMissionRockets?`${t.deliveryMissionRockets} Rockets`:"",t.deliveryMissionFuel?`${t.deliveryMissionFuel} Fuel`:""].filter(c=>!!c).join(" and "),l("MissionComputer_Complete_resource").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(t.sells,a),this.showDiv(0,"Completed")},l("MissionComputer_Complete_cargo").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(L,t.deliveryMissionRockets),e.playerShip.putCargo(G,t.deliveryMissionFuel),this.showDiv(0,"Completed")};let p=this.missionBoxesToHere.every(c=>c.total==this.missionBoxesToHere[0].total&&c.from==this.missionBoxesToHere[0].from)&&this.missionBoxesToHere[0].total==this.missionBoxesToHere.length;l("MissionComputer_Complete_component_wrap").style.display=p?"":"none",l("MissionComputer_Complete_component_name").innerText=t.deliveryMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Complete_component_select",this.deliveryMissionCompleteSelect)}else if(n.length){this.showDiv(0,"InProgress");let a=n.map(c=>c.to),p=[...new Set(a)];l("MissionComputer_InProgress_to").innerText=p.join(", ")}else e.playerShip.freeCargo<4&&e.playerShip.componentTypes[R.id]>=4?this.showDiv(0,"NoSpace"):(this.showDiv(0,"Offer"),this.deliveryMissionGivesFreeCargoBay=e.playerShip.freeCargo<4,this.deliveryMissionGivesFreeCargoBay?this.deliveryMissionGivesBoxes=4:this.deliveryMissionGivesBoxes=Math.max(1,Math.floor(e.playerShip.freeCargo/5))*4,l("MissionComputer_Offer_n").innerText=this.deliveryMissionGivesBoxes.toString(),l("MissionComputer_Offer_to").innerText=t.deliveryMissionDest,l("MissionComputer_Offer_CargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"":"none",l("MissionComputer_Offer_NoCargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"none":"",l("MissionComputer_Offer_accept").onclick=()=>{e.playerShip.putMissionBox(t.name,t.deliveryMissionDest,this.deliveryMissionGivesBoxes),this.showDiv(0,"Started")},this.fillRowSelectButtons("MissionComputer_Offer_CargoBay_select",this.deliveryMissionFreeCargoBaySelect));t.buys?(this.showDiv(1,"Cargo"),l("MissionComputer_Cargo_n").innerText=20 .toString(),l("MissionComputer_Cargo_name").innerText=t.buys.id,l("MissionComputer_Cargo_deliver").style.display=e.playerShip.cargoTypes[t.buys.id]>=20?"":"none",l("MissionComputer_Cargo_component_name").innerText=t.cargoMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Cargo_component_select",this.cargoMissionSelect)):this.showDiv(1,"None")}deliveryMissionFreeCargoBaySelect(e,t){let i=s.playerShip.onPlanet;i&&(s.playerShip.deBallastTail(),s.playerShip.addComponent(new R,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.putMissionBox(i.name,i.deliveryMissionDest,t.deliveryMissionGivesBoxes),s.walker.reattach(),t.showDiv(0,"Started"))}deliveryMissionCompleteSelect(e,t){let i=s.playerShip.onPlanet;if(!i)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new i.deliveryMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getMissionBox(i.name,t.missionBoxesToHere.length),s.walker.reattach(),t.showDiv(0,"Completed");let r=Object.values(y).filter(q);i.cargoMissionComponent=x(r)}cargoMissionSelect(e,t){let i=s.playerShip.onPlanet;if(!i?.buys)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new i.cargoMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getCargo(i.buys,20),s.walker.reattach(),t.showDiv(1,"Completed");let r=Object.values(y).filter(q);i.cargoMissionComponent=x(r)}};u(oe,"MissionComputer");var I=0;function et(){return I++,I>=he.length&&(I=0),{color:he[I],name:_e[I]}}function Ge(o){I=o}var C=class o{name;color;color2;isAlien=!1;rows=[];offsets=[];componentTypes;cargoTypes;freeCargo;i;isPlayerShip=!1;playerOnShip=!1;playerX;playerY;x;y;fromPoint;toPlanet;fromTime;toTime;isIntercepting=!1;_isBeingIntercepted=!1;interceptingShip;interceptionX;interceptionY;interceptionTime;get isBeingIntercepted(){return this._isBeingIntercepted}setIsBeingIntercepted(e){e||(e=s.star.ships),this._isBeingIntercepted=!!e.find(t=>t.isIntercepting&&t.interceptingShip==this)}updateSpaceXY(e,t=!0){if(this.isIntercepting)if(S(this.interceptingShip instanceof m||!this.interceptingShip.isIntercepting),e>=this.interceptionTime){if(S(this.interceptingShip.toTime>e),this.interceptingShip.updateSpaceXY(this.interceptionTime),this.interceptingShip.distanceTo({x:this.interceptionX,y:this.interceptionY})>.02){console.warn(`${this.interceptingShip.name} ship got away from ${this.name}, dist `,this.distanceTo(this.interceptingShip)),S(this.interceptingShip instanceof m),this.isIntercepting=!1,this.interceptingShip.setIsBeingIntercepted(),this.fromTime=e,this.fromPoint.x=this.x,this.fromPoint.y=this.y;return}this.isIntercepting=!1,this.interceptingShip.setIsBeingIntercepted(),this.fromTime=e,this.fromPoint.x=this.x=this.interceptingShip.x,this.fromPoint.y=this.y=this.interceptingShip.y,this instanceof m?(s.joinShip(this.interceptingShip),v("ship","you_intercepted",this.interceptingShip),l("status_ship_you_intercepted_continue").onclick=()=>{s.leaveShip()}):this.interceptingShip instanceof m&&(s.joinShip(this),v("ship","intercepted_uninterested",this),l("status_ship_intercepted_uninterested_continue").onclick=()=>{s.leaveShip()})}else{let i=(e-this.fromTime)/(this.interceptionTime-this.fromTime);this.x=this.fromPoint.x+(this.interceptionX-this.fromPoint.x)*i,this.y=this.fromPoint.y+(this.interceptionY-this.fromPoint.y)*i}else{for(;e>=this.toTime&&t;)S(!this.isIntercepting),S(!this.isBeingIntercepted),this.toPlanet.dispatch(this,this.toTime);let i=(e-this.fromTime)/(this.toTime-this.fromTime);this.x=this.fromPoint.x+(this.toPlanet.x-this.fromPoint.x)*i,this.y=this.fromPoint.y+(this.toPlanet.y-this.fromPoint.y)*i}}considerIntercept(e,t){if(this.isIntercepting||this.isBeingIntercepted)return;let i=_(e.filter(r=>r!=this&&!r.isIntercepting&&!r.isBeingIntercepted&&Math.hypot(this.x-r.x,this.y-r.y)>1&&r.seenBy({x:this.x,y:this.y},this.componentTypes[A.id])));for(let r of i){let n=(r.toPlanet.x-r.fromPoint.x)/(r.toTime-r.fromTime),a=(r.toPlanet.y-r.fromPoint.y)/(r.toTime-r.fromTime),p=fe(this,r,{x:n,y:a},2*.1,t);if(!(p>r.toTime-2)){this.performIntercept(r,n,a,p,t);break}}}performIntercept(e,t,i,r,n){this.isIntercepting=!0,this.interceptingShip=e,this.toPlanet=e.toPlanet,this.toTime=e.toTime,this.fromTime=n,this.fromPoint={x:this.x,y:this.y},this.interceptionX=e.x+t*(r-n),this.interceptionY=e.y+i*(r-n),this.interceptionTime=r,e.setIsBeingIntercepted()}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}planTrip(e,t){this.fromPoint=se(this),this.toPlanet=e,this.fromTime=t;let r=this.distanceTo(e)/.1;this.toTime=t+r,this.updateSpaceXY(this.fromTime)}countComponents(){this.componentTypes={};let e=Object.values(y).filter(De).forEach(i=>this.componentTypes[i.id]=0),t=this.rows.flat();for(let i of t)this.componentTypes[i.typename]++}countCargo(){let e=this.rows.flat().filter(B);this.freeCargo=0,this.cargoTypes={},Object.values(y).filter(Z).forEach(t=>this.cargoTypes[t.id]=0);for(let t of e){this.freeCargo+=5-t.cargo.length;for(let i of t.cargo)this.cargoTypes[i.typename]++}}addComponent(e,t){e.ship=this,t<0&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=0),t>=this.rows.length&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=this.rows.length-1),this.rows[t].push(e)}getCargo(e,t){if(t>this.cargoTypes[e.id])return!1;this.cargoTypes[e.id]-=t,this.freeCargo+=t;let i=this.rows.flat().filter(B).filter(r=>r.cargo.length);for(let r of i)if(r.cargo=r.cargo.filter(n=>!(n instanceof e&&t-- >0)),t<=0)return!0}getMissionBox(e,t){if(t>this.cargoTypes[M.id])return!1;this.cargoTypes[M.id]-=t,this.freeCargo+=t;let i=this.rows.flat().filter(B).filter(r=>r.cargo.length);for(let r of i)if(r.cargo=r.cargo.filter(n=>!(n instanceof M&&n.to==e&&t-- >0)),t<=0)return!0}putCargo(e,t){if(t>this.freeCargo)return!1;this.cargoTypes[e.id]+=t,this.freeCargo-=t;let i=this.rows.flat().filter(B).filter(r=>r.cargo.length<5);for(let r of i){for(;t>0&&r.cargo.length<5;)r.cargo.push(new e),t--;if(t<=0)return!0}}putMissionBox(e,t,i){if(i>this.freeCargo)return!1;this.cargoTypes[M.id]+=i,this.freeCargo-=i;let r=this.rows.flat().filter(B).filter(a=>a.cargo.length<5),n=i;for(let a of r){for(;n>0&&a.cargo.length<5;){let p=new M;p.from=e,p.to=t,p.total=i,a.cargo.push(p),n--}if(n<=0)return!0}}seenBy(e,t){let i=this.distanceTo(e);return!0}toJSON(){return{a:this.isAlien,n:this.name,c:this.color,o:this.offsets,r:this.rows.map(e=>e.map(t=>t.toJSON())),frX:this.fromPoint?.x,frY:this.fromPoint?.y,frT:this.fromTime,toP:this.toPlanet?.i,toT:this.toTime,ii:this.isIntercepting,is:this.interceptingShip?.i,iX:this.interceptionX,iY:this.interceptionY,iT:this.interceptionTime}}static fromJSON(e,t,i){i||(i=new o),i.isAlien=e.a,i.name=e.n,i.color=e.c,i.color2="#"+ne(e.c.substr(1)),i.offsets=e.o,i.rows=[];for(let r=0;r<e.r.length;r++){i.rows[r]=[];for(let n=0;n<e.r[r].length;n++)i.addComponent(ae(e.r[r][n]),r)}return i.fromPoint={x:e.frX,y:e.frY},i.fromTime=e.frT,i.toTime=e.toT,t&&(i.toPlanet=t.planets[e.toP]),e.ii&&(i.isIntercepting=e.ii,i.interceptionX=e.iX,i.interceptionY=e.iY,i.interceptionTime=e.iT),i.fillBallastOpposite(),i.countComponents(),i}toHTML(e,t){let i="";if(t){let a=t.distanceTo(this);a<.01&&(a=0),i=` (${Math.ceil(a/.1)} d)`}let r=`<span class="colorBox" style="background:${this.color};border-color:${this.color2}"></span>`,n=this.isAlien?"<i>Alien</i>":this.rows.length%2?"<i>Odd</i>":"";return`${r} ${n}${e?"ship ":""}<b>${this.name}</b>${i}`}get gridSize(){if(this.isAlien)return{x0:0,x1:0,y0:0,y1:0,w:0,h:0};{let e=0,t=0;for(let i=0;i<this.rows.length;i++)e=Math.max(e,this.rows[i].length-this.offsets[i]),t=Math.max(t,this.offsets[i]);return{x0:0,x1:this.rows.length-1,y0:e,y1:t,w:this.rows.length,h:e+t+1}}}rowToXY(e,t){return this.isAlien?{x:0,y:0}:t>=this.offsets[e]?{x:e,y:1+(t-this.offsets[e])}:{x:e,y:t-this.offsets[e]}}get passage(){return this.isAlien?{x:0,y:0,w:0,h:0}:{x:0,y:0,w:this.rows.length,h:1}}oppositeComponent(e){for(let t=0;t<=this.rows.length;t++){let i=this.rows[t].indexOf(e);if(i>=0)return this.rows[this.rows.length-1-t][i]}}static randomShip(e,t){let r=Object.values(y).filter(q),n=Object.values(y).filter(Oe),a=r.concat(n),p=Object.values(y).filter(Z);t===void 0&&(t=new o);let c=et(),k=c.color;t.name=c.name,t.color="#"+k,t.color2="#"+ne(k),t.rows=[[],[],[],[]],t.offsets=[0,0,0,0];for(let f=0;f<e;f++){let D=x(a),H=new D;if(H instanceof R){let Je=b(0,5);for(let ve=0;ve<Je;ve++){let Xe=x(p);H.cargo.push(new Xe)}}t.addComponent(H,b(0,3))}for(let f=0;f<t.rows.length;f++)t.offsets[f]=b(0,t.rows[f].length);return t.balanceBallast(),t.countComponents(),t}static newBase(){let e=new o,t=x(he);e.color="#"+t,e.color2="#"+ne(t),e.rows=[[],[],[]];let i=_([new te,new A,new ie,new oe]);for(let r of i)e.addComponent(r,b(0,2));return e.offsets=[b(0,e.rows[0].length),b(0,e.rows[1].length),b(0,e.rows[2].length)],e.balanceBallast(),e.countComponents(),e}deBallastTail(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof w;)this.rows[e].pop()}}balanceBallast(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.offsets[e]<this.offsets[t-e];)this.rows[e].unshift(new w),this.offsets[e]++;for(var e=0;e<=t;e++)for(;this.rows[e].length<this.rows[t-e].length;)this.rows[e].push(new w);for(var e=0;e<=t;e++)for(;this.rows[e][0]instanceof w&&this.rows[t-e][0]instanceof w;)this.rows[e].shift(),this.rows[t-e].shift(),this.offsets[e]--,this.offsets[t-e]++;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof w&&this.rows[t-e].at(-1)instanceof w;)this.rows[e].pop(),this.rows[t-e].pop()}this.fillBallastOpposite()}fillBallastOpposite(){if(!this.isAlien){let i=this.rows.length-1;for(var e=0;e<=i;e++)for(var t=0;t<=this.rows[e].length;t++)this.rows[e][t]instanceof w&&(this.rows[e][t].opposite=this.rows[i-e][t].typename)}}get topAirlock(){if(this.isAlien)return 0;{let e=0;for(let t=0;t<this.rows.length;t++)e=Math.max(e,this.rows[t].length-this.offsets[t]);for(let t=0;t<this.rows.length;t++)if(this.rows[t].length-this.offsets[t]==e)return t;return 0}}get bottomAirlock(){if(this.isAlien)return 0;{let e=Math.max(...this.offsets);return this.offsets.lastIndexOf(e)}}};var Re=function(){let o=[E,X,z,U];for(var e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],t=[["ocean",null,E,"navy","blue"],["desert",E,G,"blue","purple"],["factory",X,L,"yellow","orange"],["war",L,G,"orange","purple"]],i=0;i<4;i++)for(var r=0;r<4;r++)i!=r&&t.push([e[i][r],o[i],o[r],o[i].color,o[r].color]);return t}(),ge=class o{x;y;i;type;name;buys;sells;ratio;color_in;color_out;neighbours;base;deliveryMissionDest;deliveryMissionComponent;deliveryMissionRockets;deliveryMissionFuel;cargoMissionComponent;constructor(e){var t=Re[e];this.type=e,this.name=t[0],this.buys=t[1],this.sells=t[2],this.color_in=t[3],this.color_out=t[4]}toJSON(){return{x:this.x,y:this.y,tp:this.type,b:this.base.toJSON(),dd:this.deliveryMissionDest,dc:this.deliveryMissionComponent?.id,dr:this.deliveryMissionRockets,df:this.deliveryMissionFuel,cc:this.cargoMissionComponent?.id}}static fromJSON(e){let t=new o(e.tp);return t.x=e.x,t.y=e.y,e.b?t.base=C.fromJSON(e.b):t.base=C.newBase(),e.dd&&(t.deliveryMissionDest=e.dd),e.dc&&(t.deliveryMissionComponent=y[e.dc]),e.dr&&(t.deliveryMissionRockets=e.dr),e.df&&(t.deliveryMissionFuel=e.df),e.cc&&(t.cargoMissionComponent=y[e.cc]),t}toHTML(e,t,i){let r="";if(t){let p=t.distanceTo(this);p<.01&&(p=0),r=` (${Math.ceil(p/.1)} d)`}let a=`${`<span class="colorCircle" style="background: radial-gradient(closest-side, ${this.color_in}, ${this.color_out});"></span>`} <b>${this.name}</b>${e?" planet":""}${r}`;return i&&(a+=`<br>${this.buys?`wants: ${this.buys.id}`:""} ${this.sells?`gives: ${this.sells.id}`:""}`),a}dispatch(e,t){let i=this.neighbours.shift();this.neighbours.push(i),e.planTrip(i,t)}onEnter(){this.deliveryMissionDest=x(this.neighbours).name;let e=Object.values(y).filter(q);this.cargoMissionComponent=x(e),this.deliveryMissionComponent=x(e);let t=s.playerShip.rows.flat().filter(B),i=[];for(let n of t)i=i.concat(n.cargo.filter(pe));let r=i.filter(n=>n.to===this.name);if(r.length){let n=Math.max(1,Math.floor(r.length/2));this.deliveryMissionRockets=b(0,n),this.deliveryMissionFuel=n-this.deliveryMissionRockets}}};function tt(o,e,t){var i=t/2;return o<i+.6&&o>i-.6&&e<i+.6&&e>i-.6}function Ne(o){for(var e=_(O(Re.length)),t=0;t<100;t++){for(var i=!1,r=[],n=_(O(o)),a=_(O(o)),p=o/2,c=0;c<o;c++)tt(n[c]+.5,a[c]+.5,o)&&(i=!0),r.push({x:n[c]+.5,y:a[c]+.5,tp:e[c]});if(!i)return r}return console.error("should not be here"),[]}var it=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function ot(o,e){for(var t=O(e).map(a=>[]),i=(e-1)/2,r=Math.floor(i);r<=Math.ceil(i);r++)for(var n=Math.floor(i);n<=Math.ceil(i);n++)t[r+1][n+1]=o;return t}var W=class{color;size;bright;name;grid;planets;ships;constructor(e){e||(e={c:x(it),sz:b(5,9),p:!1,sh:!1}),this.color=e.c,this.size=e.sz,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.grid=ot(this,this.size),e.p||(e.p=Ne(this.size)),this.planets=e.p.map(t=>ge.fromJSON(t));for(let t=0;t<this.planets.length;t++){let i=this.planets[t];i.i=t,i.neighbours=_(this.planets.filter(r=>r!=i&&!this.pathCollides(r,i))),this.grid[Math.floor(i.x)][Math.floor(i.y)]=i}if(e.sh){this.ships=e.sh.map(t=>t.p?m.fromJSON(t,this):C.fromJSON(t,this));for(let t=0;t<this.ships.length;t++)this.ships[t].i=t,this.ships[t].isIntercepting&&(this.ships[t].interceptingShip=this.ships[e.sh[t].is],this.ships[t].interceptingShip.setIsBeingIntercepted(this.ships))}this.setRatios()}pathCollides(e,t){if(be(e,t,{x:this.size/2,y:this.size/2},.5))return!0;for(var i of this.planets)if(i!=e&&i!=t&&be(e,t,i,.2))return!0;return!1}computeRareResources(e){e===void 0&&(e=this.planets);let t=e.map(n=>n.sells),i=Object.values(y).filter(Z).filter(n=>!t.includes(n)),r=e.filter(n=>n.buys===null).map(n=>n.sells);return{exotic:i,abundant:r}}setRatios(){let e=this.computeRareResources();for(let t of this.planets)t.buys===null?t.ratio=2:e.abundant.includes(t.buys)?t.ratio=1:e.exotic.includes(t.buys)?t.ratio=2:t.ratio=1.4}addRandomShips(e){this.ships=[];for(let t=0;t<this.planets.length;t++)for(let i=0;i<t;i++){if(this.planets[t].neighbours.indexOf(this.planets[i])<0)continue;let r=C.randomShip(15);r.x=this.planets[t].x,r.y=this.planets[t].y;let a=Math.hypot(this.planets[t].x-this.planets[i].x,this.planets[t].y-this.planets[i].y)/.1;this.planets[t].dispatch(r,e-a),this.ships.push(r),this.ships.at(-1).i=this.ships.length-1}}toJSON(){return{c:this.color,sz:this.size,p:this.planets.map(e=>e.toJSON()),sh:this.ships.map(e=>e.toJSON())}}};var de=class o{_state;star;playerShip;withShip;walker;now=0;lastTickTimestamp;lastDate;_timeFlies=!1;tickInterval=0;get state(){return this._state}set state(e){this._state!=e&&(this._state=e,this.timeFlies=e==0)}get timeFlies(){return this._timeFlies}set timeFlies(e){if(this._timeFlies!=e)if(this._timeFlies=e,e){let t=this;this.lastTickTimestamp=performance.now(),this.tickInterval=setInterval(function(){t.tick()},1e3)}else clearInterval(this.tickInterval)}tick(e){if(!this.timeFlies)return!1;if(e||(e=performance.now()),e<=this.lastTickTimestamp)return!0;this.now+=Math.max(0,Math.min(e-this.lastTickTimestamp,1e3))/1e3,this.lastTickTimestamp=e;let t=Math.floor(this.now);for(let i of this.star.ships)i.updateSpaceXY(this.now);if(this.lastDate!=t){if(re(t),this.lastDate=t,this.timeFlies){let i=Math.ceil(this.playerShip.toTime-this.now);if(v("planet","travelling",this.playerShip.toPlanet,i),this.playerShip.isIntercepting){let r=Math.ceil(this.playerShip.interceptionTime-this.now);v("ship","intercepting",this.playerShip.interceptingShip,r)}}for(let i of this.star.ships)i.considerIntercept(this.star.ships,this.now)}return!0}depart(){S(this.state==1),this.state=0,this.timeFlies=!0,this.playerShip.onPlanet=null,this.walker.detach(),this.lastDate=-1,this.tick()}arrive(e,t){S(this.state==0),this.playerShip.onPlanet=this.playerShip.toPlanet,this.playerShip.x=this.playerShip.onPlanet.x,this.playerShip.y=this.playerShip.onPlanet.y,this.state=1,this.timeFlies=!1,e||this.playerShip.onPlanet.onEnter(),this.walker.attach(this.playerShip.onPlanet.base),v("planet","docked",this.playerShip.onPlanet),t||(localStorage.space2d3_3=JSON.stringify(this.toJSON()))}joinShip(e){S(this.state==0),this.state=2,this.withShip=e,this.timeFlies=!1}leaveShip(){S(this.state==2),s.state=0,this.timeFlies=!0,v("ship","none"),this.walker.triggerOnEnter()}toJSON(){return{v:2,s:this.star.toJSON(),n:this.now,ns:I}}static fromJSON(e){if(e?.v!=2)return!1;let t=new o;t.star=new W(e.s);let i=t.star.ships.filter(Ee);return i.length!=1?!1:(t.playerShip=i[0],t.now=e.n,Ge(e.ns||0),t)}};function Ie(o){let e=de.fromJSON(o);return e?(s=e,!0):!1}function He(){s&&(s.timeFlies=!1),s=new de}var s;var m=class o extends C{onPlanet;targetShip;updateSpaceXY(e,t=!0){switch(s.state){case 0:e>=this.toTime&&t?s.arrive():super.updateSpaceXY(e,!1);break;case 1:S(this.onPlanet),this.x=this.onPlanet.x,this.y=this.onPlanet.y;break;case 2:S(!s.timeFlies),super.updateSpaceXY(e,!1);break}}considerIntercept(){}static randomShip(e){let t=new o;return C.randomShip(e,t),t.name="Your Ship",t}toJSON(){let e=super.toJSON();return e.p=!0,this.onPlanet!=null&&(e.on=this.onPlanet.i),e}static fromJSON(e,t){let i=new o;return C.fromJSON(e,t,i),i}};function Ee(o){return o instanceof m}var Se=class{x;y;map;box;human;canvas;ctx;onEnter;oneShipData;twoShipsData;hasSecondShip=!1;myShip;secondShip;newMap(e,t){this.map=[];for(let i=0;i<=e;i++){this.map[i]=[];for(let r=0;r<=t;r++)this.map[i][r]={}}}triggerOnEnter(){this.onEnter(this.map[this.x][this.y].component)}goX(e){return!this.map[this.x][this.y].canGoX||!this.map[this.x+e][this.y].canBeHere?!1:(this.x+=e,this.reposition(),this.triggerOnEnter(),!0)}goY(e,t){return!t&&!this.map[this.x][this.y].canGoY||!this.map[this.x][this.y+e].canBeHere?!1:(this.y+=e,this.reposition(),this.triggerOnEnter(),!0)}goUp(){this.goY(-1),this.human.style.transform="rotate(180deg)"}goDn(e){this.goY(1,e),this.human.style.transform="rotate(0deg)"}goLt(){this.goX(-1),this.human.style.transform="rotate(90deg)"}goRt(){this.goX(1),this.human.style.transform="rotate(-90deg)"}jumpTo(e,t,i=!0){this.x=e,this.y=t,this.reposition(!0),i&&this.triggerOnEnter()}reposition(e){e&&this.canvas.classList.add("notransition");let t=(this.x+.5)*h,r=this.box.offsetWidth/2-t;this.canvas.style.left=r+"px";let n=(this.y+.5)*h,p=this.box.offsetHeight/2-n;this.canvas.style.top=p+"px",e&&(this.canvas.offsetHeight,this.canvas.classList.remove("notransition"))}putTwoShips(e,t){let i=e.gridSize,r=t.gridSize,n=e.bottomAirlock,a=t.topAirlock,p=Math.max(n,a)+1,c=i.h+1,k=p+Math.max(i.w-n,r.w-a),f=c+r.h+1;this.myShip=t,this.secondShip=e,this.hasSecondShip=!0,this.twoShipsData={ax0:p-n+i.x0,ay0:i.y0+1,airlock_x:p,airlock_y:c,bx0:p-a+r.x0,by0:c+r.y0+1,max_x:k,max_y:f}}drawTwoShips(e,t){this.putTwoShips(e,t);let i=this.twoShipsData;this.newMap(i.max_x,i.max_y),this.ctx.canvas.width=h*(i.max_x+1),this.ctx.canvas.height=h*(i.max_y+1),me(this.ctx,i.ax0,i.ay0,e,this.map),me(this.ctx,i.bx0,i.by0,t,this.map),Pe(this.ctx,i.airlock_x,i.airlock_y,e,t,this.map)}drawMyShip(){this.hasSecondShip=!1;let e=this.oneShipData=this.myShip.gridSize;this.newMap(e.w+1,e.h+1),this.ctx.canvas.width=h*(e.w+2),this.ctx.canvas.height=h*(e.h+2),me(this.ctx,e.x0+1,e.y0+1,this.myShip,this.map)}detach(){if(!this.hasSecondShip)return!1;let e=!1;if(this.y==this.twoShipsData.airlock_y&&(this.y++,e=!0),this.secondShip.playerOnShip=this.y<this.twoShipsData.airlock_y,this.myShip.playerOnShip=this.y>this.twoShipsData.airlock_y,!(this.y<this.twoShipsData.airlock_y)){let t=this.myShip.playerX=this.x-this.twoShipsData.bx0,i=this.myShip.playerY=this.y-this.twoShipsData.by0;this.drawMyShip(),e?(this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+i,!1),this.goDn(!0)):this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+1+i,!1)}}attach(e){if(this.hasSecondShip)return!1;let t=this.x-1-this.oneShipData.x0,i=this.y-1-this.oneShipData.y0;this.drawTwoShips(e,this.myShip),this.jumpTo(this.twoShipsData.bx0+t,this.twoShipsData.by0+i)}reattach(){if(!this.hasSecondShip)return!1;if(this.y>=this.twoShipsData.airlock_y)return;let e=this.secondShip.playerX=this.x-this.twoShipsData.ax0,t=this.secondShip.playerY=this.y-this.twoShipsData.ay0;this.drawTwoShips(this.secondShip,this.myShip),this.jumpTo(this.twoShipsData.ax0+e,this.twoShipsData.ay0+t)}};(location.hostname=="localhost"||location.hostname=="127.0.0.1")&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var $e={a:!1,n:"Your Ship",c:"#5E5E5E",o:[0,0],r:[[{t:"CargoBay",c:[{t:"Water"},{t:"Food"},{t:"Iron"},{t:"Radioactives"}]}],[{t:"Ballast"}]],frX:0,frY:0,frT:-1,toP:0,toT:0,p:!0};window.matchMedia("(prefers-color-scheme: dark)").matches&&($e.c="#919191");var d=new Se,Ae=l("myCanvas"),rt=Ae.getContext("2d");d.box=l("canvasBox");d.human=l("human");d.canvas=Ae;d.ctx=rt;d.onEnter=st;window.onresize=()=>{s.walker.reposition(!0)};function Fe(o){He(),s.star=new W,s.star.addRandomShips(0),o?s.playerShip=m.fromJSON(o,s.star):s.playerShip=m.randomShip(15),s.star.ships.push(s.playerShip),s.playerShip.fromPoint=se(s.star.planets[1]),s.playerShip.toPlanet=s.star.planets[1],s.now=0,Ye(!0)}function nt(){return Ie(JSON.parse(localStorage.space2d3_3))?(Ye(),!0):!1}function Ye(o=!1){d.myShip=s.playerShip,d.drawMyShip(),d.jumpTo(d.oneShipData.x0+1,d.oneShipData.y0+1),s.walker=d,l("main").style.display="flex",s.state=0,s.arrive(!o,o),re(Math.floor(s.now));let t=l("systemCanvas").getContext("2d");Be(t,s.star);for(let i of s.star.ships)i.updateSpaceXY(s.now,!1);v("ship","none"),window.gs=s}l("newGameEasy").onclick=()=>{Fe($e)};l("newGameHard").onclick=()=>{Fe()};localStorage.space2d3_3?nt()||(localStorage.space2d3_3=prompt("Error loading game. Fix savegame data below or press Cancel to delete savegame and start anew",localStorage.space2d3_3)||"",location.reload()):l("newGameDialog").showModal();l("newGameButton").onclick=()=>{l("newGameCancelBox").style.display="",l("newGameDialog").showModal()};window.onkeypress=o=>{switch(o.key){case"w":d.goUp();break;case"a":d.goLt();break;case"s":d.goDn();break;case"d":d.goRt();break}};function st(o){o&&(l("currentComponent").innerHTML=`#${o.typename} {display:block}`,o.cellName?l("componentLegend").innerText=`${o.cellName}: ${o.typename}`:l("componentLegend").innerText=`${o.typename}`,o.onEnter(s))}})();
//# sourceMappingURL=script.js.map
